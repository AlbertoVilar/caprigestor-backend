package com.devmaster.goatfarm.config.security;

import com.devmaster.goatfarm.authority.model.entity.User;
import com.devmaster.goatfarm.authority.model.repository.UserRepository;
import com.devmaster.goatfarm.config.exceptions.custom.ResourceNotFoundException;
import com.devmaster.goatfarm.farm.model.entity.GoatFarm;
import com.devmaster.goatfarm.farm.model.repository.GoatFarmRepository;
import com.devmaster.goatfarm.goat.model.entity.Goat;
import com.devmaster.goatfarm.goat.model.repository.GoatRepository;
import com.devmaster.goatfarm.events.model.entity.Event;
import com.devmaster.goatfarm.events.model.repository.EventRepository;
import com.devmaster.goatfarm.address.model.entity.Address;
import com.devmaster.goatfarm.phone.model.entity.Phone;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;

/**
 * Service para verifica√ß√£o de ownership (propriedade) de recursos.
 * Centraliza a l√≥gica de verifica√ß√£o se um usu√°rio tem permiss√£o para acessar/modificar recursos.
 */
@Service
public class OwnershipService {

    private static final Logger logger = LoggerFactory.getLogger(OwnershipService.class);

    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private GoatFarmRepository goatFarmRepository;
    
    @Autowired
    private GoatRepository goatRepository;
    
    @Autowired
    private EventRepository eventRepository;

    /**
     * Obt√©m o usu√°rio atualmente autenticado
     * @return User autenticado
     * @throws RuntimeException se n√£o h√° usu√°rio autenticado
     */
    public User getCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication != null && authentication.isAuthenticated() && !"anonymousUser".equals(authentication.getPrincipal())) {
            String email = authentication.getName();
            return userRepository.findByEmail(email)
                    .orElseThrow(() -> new RuntimeException("Usu√°rio autenticado n√£o encontrado: " + email));
        }
        throw new RuntimeException("Usu√°rio n√£o autenticado");
    }

    /**
     * Verifica se o usu√°rio atual √© ADMIN
     * @return true se for ADMIN, false caso contr√°rio
     */
    public boolean isCurrentUserAdmin() {
        try {
            User currentUser = getCurrentUser();
            return currentUser.getRoles().stream()
                    .anyMatch(role -> role.getAuthority().equals("ROLE_ADMIN"));
        } catch (RuntimeException e) {
            return false;
        }
    }

    /**
     * Verifica se o usu√°rio atual √© ADMIN ou OPERATOR
     * @return true se for ADMIN ou OPERATOR, false caso contr√°rio
     */
    public boolean isCurrentUserAdminOrOperator() {
        try {
            User currentUser = getCurrentUser();
            return currentUser.getRoles().stream()
                    .anyMatch(role -> role.getAuthority().equals("ROLE_ADMIN") || role.getAuthority().equals("ROLE_OPERATOR"));
        } catch (RuntimeException e) {
            return false;
        }
    }

    /**
     * Verifica se o usu√°rio atual tem permiss√£o para acessar uma fazenda
     * ADMIN e OPERATOR t√™m acesso a tudo, FARM_OWNER s√≥ √† pr√≥pria fazenda
     * @param farm Fazenda a ser verificada
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyFarmOwnership(GoatFarm farm) {
        User currentUser = getCurrentUser();
        logger.debug("üîç OWNERSHIP: Verificando acesso para usu√°rio: {}", currentUser.getEmail());
        logger.debug("üîç OWNERSHIP: Roles do usu√°rio: {}", currentUser.getRoles().stream().map(r -> r.getAuthority()).toList());
        
        // ADMIN e OPERATOR t√™m acesso a tudo
        if (isCurrentUserAdminOrOperator()) {
            logger.debug("‚úÖ OWNERSHIP: Usu√°rio √© ADMIN ou OPERATOR - acesso liberado");
            return;
        }

        // Verificar se o usu√°rio √© propriet√°rio da fazenda
        if (farm == null) {
            logger.warn("‚ùå OWNERSHIP: Fazenda √© null");
            throw new ResourceNotFoundException("Fazenda n√£o encontrada");
        }

        logger.debug("üîç OWNERSHIP: Fazenda ID: {}, Propriet√°rio ID: {}", farm.getId(), (farm.getUser() != null ? farm.getUser().getId() : "null"));
        logger.debug("üîç OWNERSHIP: Usu√°rio atual ID: {}", currentUser.getId());
        
        if (farm.getUser() == null || !farm.getUser().getId().equals(currentUser.getId())) {
            throw new ResourceNotFoundException("Acesso negado: Voc√™ n√£o tem permiss√£o para acessar esta fazenda");
        }
    }

    /**
     * Verifica se o usu√°rio atual tem permiss√£o para acessar uma fazenda (vers√£o para VO)
     * ADMIN e OPERATOR t√™m acesso a tudo, FARM_OWNER s√≥ √† pr√≥pria fazenda
     * @param farmVO Fazenda VO a ser verificada
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyFarmOwnership(com.devmaster.goatfarm.farm.business.bo.GoatFarmFullResponseVO farmVO) {
        User currentUser = getCurrentUser();
        
        // ADMIN e OPERATOR t√™m acesso a tudo
        if (isCurrentUserAdminOrOperator()) {
            return;
        }

        // Verificar se o usu√°rio √© propriet√°rio da fazenda
        if (farmVO == null) {
            throw new ResourceNotFoundException("Fazenda n√£o encontrada");
        }

        if (farmVO.getUserId() == null || !farmVO.getUserId().equals(currentUser.getId())) {
            throw new ResourceNotFoundException("Acesso negado: Voc√™ n√£o tem permiss√£o para acessar esta fazenda");
        }
    }

    /**
     * Verifica se o usu√°rio atual tem permiss√£o para acessar uma cabra
     * ADMIN e OPERATOR t√™m acesso a tudo, FARM_OWNER s√≥ √†s cabras da pr√≥pria fazenda
     * @param goat Cabra a ser verificada
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyGoatOwnership(Goat goat) {
        User currentUser = getCurrentUser();
        
        // ADMIN e OPERATOR t√™m acesso a tudo
        if (isCurrentUserAdminOrOperator()) {
            return;
        }

        // Verificar se a cabra est√° associada a uma fazenda
        if (goat == null) {
            throw new ResourceNotFoundException("Cabra n√£o encontrada");
        }

        if (goat.getFarm() == null) {
            throw new ResourceNotFoundException("Cabra n√£o est√° associada a nenhuma fazenda");
        }

        // Verificar se o usu√°rio √© propriet√°rio da fazenda da cabra
        if (!goat.getFarm().getUser().getId().equals(currentUser.getId())) {
            throw new ResourceNotFoundException("Acesso negado: Voc√™ n√£o tem permiss√£o para acessar cabras desta fazenda");
        }
    }

    /**
     * Verifica se o usu√°rio atual tem permiss√£o para acessar dados de um usu√°rio espec√≠fico
     * ADMIN e OPERATOR t√™m acesso a tudo, outros usu√°rios s√≥ aos pr√≥prios dados
     * @param userId ID do usu√°rio a ser verificado
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyUserAccess(Long userId) {
        User currentUser = getCurrentUser();
        
        // ADMIN e OPERATOR t√™m acesso a tudo
        if (isCurrentUserAdminOrOperator()) {
            return;
        }

        // Usu√°rio s√≥ pode acessar os pr√≥prios dados
        if (!currentUser.getId().equals(userId)) {
            throw new ResourceNotFoundException("Acesso negado: Voc√™ n√£o tem permiss√£o para acessar dados de outro usu√°rio");
        }
    }

    /**
     * Verifica se o usu√°rio atual pode criar recursos em uma fazenda espec√≠fica
     * @param farmId ID da fazenda
     * @param farm Entidade da fazenda (opcional, se j√° carregada)
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyCanCreateInFarm(Long farmId, GoatFarm farm) {
        User currentUser = getCurrentUser();
        
        // ADMIN e OPERATOR podem criar em qualquer fazenda
        if (isCurrentUserAdminOrOperator()) {
            return;
        }

        // Se a fazenda foi fornecida, usar ela
        if (farm != null) {
            verifyFarmOwnership(farm);
            return;
        }

        // Buscar fazenda pelo ID e verificar ownership
        GoatFarm foundFarm = goatFarmRepository.findById(farmId)
                .orElseThrow(() -> new ResourceNotFoundException("Fazenda n√£o encontrada com ID: " + farmId));
        verifyFarmOwnership(foundFarm);
    }
    
    // ========== M√âTODOS DE VERIFICA√á√ÉO POR ID ==========
    
    /**
     * Verifica ownership de fazenda por ID
     * @param farmId ID da fazenda
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyFarmOwnershipById(Long farmId) {
        if (isCurrentUserAdminOrOperator()) {
            return;
        }
        
        GoatFarm farm = goatFarmRepository.findById(farmId)
                .orElseThrow(() -> new ResourceNotFoundException("Fazenda n√£o encontrada com ID: " + farmId));
        verifyFarmOwnership(farm);
    }
    
    /**
     * Verifica ownership de cabra por n√∫mero de registro
     * @param registrationNumber N√∫mero de registro da cabra
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyOwnershipByGoatId(String registrationNumber) {
        if (isCurrentUserAdminOrOperator()) {
            return;
        }
        
        Goat goat = goatRepository.findById(registrationNumber)
                .orElseThrow(() -> new ResourceNotFoundException("Cabra n√£o encontrada com registro: " + registrationNumber));
        verifyGoatOwnership(goat);
    }
    
    /**
     * Verifica ownership de evento por ID
     * @param eventId ID do evento
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyOwnershipByEventId(Long eventId) {
        if (isCurrentUserAdminOrOperator()) {
            return;
        }
        
        Event event = eventRepository.findById(eventId)
                .orElseThrow(() -> new ResourceNotFoundException("Evento n√£o encontrado com ID: " + eventId));
        
        if (event.getGoat() == null || event.getGoat().getFarm() == null) {
            throw new ResourceNotFoundException("Evento n√£o est√° associado a uma fazenda v√°lida");
        }
        
        verifyFarmOwnership(event.getGoat().getFarm());
    }
    
    /**
     * Verifica se o usu√°rio atual tem permiss√£o para acessar um endere√ßo
     * Endere√ßos s√£o acess√≠veis apenas se est√£o associados a fazendas do usu√°rio
     * @param address Endere√ßo a ser verificado
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyAddressOwnership(Address address) {
        if (isCurrentUserAdminOrOperator()) {
            return;
        }
        
        if (address == null) {
            throw new ResourceNotFoundException("Endere√ßo n√£o encontrado");
        }
        
        // Buscar fazenda que usa este endere√ßo
        GoatFarm farm = goatFarmRepository.findAll().stream()
                .filter(f -> f.getAddress() != null && f.getAddress().getId().equals(address.getId()))
                .findFirst()
                .orElseThrow(() -> new ResourceNotFoundException("Endere√ßo n√£o est√° associado a nenhuma fazenda"));
        
        verifyFarmOwnership(farm);
    }
    
    /**
     * Verifica se o usu√°rio atual tem permiss√£o para acessar um telefone
     * Telefones s√£o acess√≠veis apenas se est√£o associados a fazendas do usu√°rio
     * @param phone Telefone a ser verificado
     * @throws ResourceNotFoundException se n√£o tem permiss√£o
     */
    public void verifyPhoneOwnership(Phone phone) {
        if (isCurrentUserAdminOrOperator()) {
            return;
        }
        
        if (phone == null) {
            throw new ResourceNotFoundException("Telefone n√£o encontrado");
        }
        
        if (phone.getGoatFarm() == null) {
            throw new ResourceNotFoundException("Telefone n√£o est√° associado a nenhuma fazenda");
        }
        
        verifyFarmOwnership(phone.getGoatFarm());
    }
    
    // ========== M√âTODOS AUXILIARES ==========
    
    /**
     * Verifica se o usu√°rio atual √© propriet√°rio de uma fazenda espec√≠fica
     * @param farmId ID da fazenda
     * @return true se for propriet√°rio, false caso contr√°rio
     */
    public boolean isOwnerOfFarm(Long farmId) {
        try {
            verifyFarmOwnershipById(farmId);
            return true;
        } catch (ResourceNotFoundException e) {
            return false;
        }
    }
    
    /**
     * Obt√©m o ID do usu√°rio atual
     * @return ID do usu√°rio autenticado
     */
    public Long getCurrentUserId() {
        return getCurrentUser().getId();
    }
    
    /**
     * Verifica se o usu√°rio atual tem uma role espec√≠fica
     * @param roleName Nome da role (ex: "ROLE_ADMIN")
     * @return true se tem a role, false caso contr√°rio
     */
    public boolean hasRole(String roleName) {
        try {
            User currentUser = getCurrentUser();
            return currentUser.getRoles().stream()
                    .anyMatch(role -> role.getAuthority().equals(roleName));
        } catch (RuntimeException e) {
            return false;
        }
    }
}